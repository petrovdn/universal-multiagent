# Краткая инструкция по тестированию контекстного управления

## Быстрый тест (3 шага)

### 1. Поиск файла
```
Запрос: "Найди файл test2"
```
**Ожидаемое:** Файл найден, ID сохранен в entity memory

### 2. Референс к файлу (ПРОСТОЕ действие)
```
Запрос: "Открой этот файл"
```
**Ожидаемое:**
- ✅ Классифицируется как **SIMPLE** (без планирования)
- ✅ Файл открывается напрямую по ID из entity memory
- ✅ План НЕ содержит шага "Использовать найденный файл из контекста"
- ✅ План содержит только: "Открыть файл test2"

### 3. Референс с продолжением (СЛОЖНОЕ действие)
```
Запрос: "Теперь сделай краткое содержание того, что в этом файле"
```
**Ожидаемое:**
- ✅ Классифицируется как **COMPLEX** (с планированием)
- ✅ Референс "этом" распознается (все формы слова)
- ✅ Система использует уже открытый файл и его содержимое
- ✅ НЕ планирует повторный поиск/открытие файла

## Проверка в логах

```bash
# Проверка распознавания референсов
grep "Reference detected" .cursor/debug.log

# Проверка классификации
grep "Simple action with reference" .cursor/debug.log
grep "Complex action with reference" .cursor/debug.log

# Проверка извлечения entity
grep "Entity extraction completed" .cursor/debug.log

# Проверка передачи контекста в выполнение шага
grep "Step execution context prepared" .cursor/debug.log
# Должно показывать: recent_messages_count > 0, has_entity_context: true/false
```

## Дополнительный тест: Контекст предыдущих ответов

### Тест использования данных из предыдущих ответов
```
Шаг 1: "Составь поздравление для Зины"
Шаг 2: "А ты возьми поздравление Зины из нашего текущего контекста, на предыдущем шаге ты его составлял, вот и возьми"
```

**Ожидаемое:**
- ✅ Система видит свой предыдущий ответ (поздравление Зины)
- ✅ Использует текст поздравления из контекста
- ✅ НЕ просит пользователя предоставить текст заново
- ✅ НЕ пытается искать поздравление в Google Drive

### Тест извлечения главной мысли из предыдущего ответа
```
Шаг 1: "Составь поздравление для Васи"
Шаг 2: "Теперь из этого поздравления выдели главную мысль и напиши ее"
```

**Ожидаемое:**
- ✅ Система видит свое предыдущее поздравление
- ✅ Извлекает главную мысль из контекста
- ✅ НЕ пытается искать поздравление в Google Drive
- ✅ НЕ просит пользователя предоставить текст

**Проверка:**
- Система должна найти поздравление в контексте и использовать его
- НЕ должно быть сообщения "ТРЕБУЕТСЯ ПОМОЩЬ ПОЛЬЗОВАТЕЛЯ" с просьбой предоставить текст
- НЕ должно быть попыток поиска в Google Drive

## Критерии успеха

✅ **Тест пройден, если:**
1. Референсы распознаются (включая формы "этом", "этого")
2. Простые действия с референсами → SIMPLE (без планирования)
3. План не содержит избыточных шагов типа "Использовать файл из контекста"
4. Содержимое файла доступно в следующем запросе
5. **Система видит свои предыдущие ответы и может использовать данные из них**

❌ **Тест НЕ пройден, если:**
1. Референсы не распознаются
2. Простые действия классифицируются как COMPLEX
3. План содержит избыточные шаги
4. Система не видит содержимое файла в следующем запросе
5. **Система не видит свои предыдущие ответы и просит предоставить данные заново**

