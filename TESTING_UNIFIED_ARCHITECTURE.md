# Руководство по тестированию унифицированной ReAct архитектуры

## Быстрый старт

### 1. Быстрый тест (рекомендуется начать с этого)

```bash
python3 test_quick_unified.py
```

**Что проверяет:**
- Загрузка MCP Provider и классификация инструментов
- Инициализация CapabilityRegistry
- Фильтрация capabilities по категориям (READ/WRITE)
- Health check провайдеров
- Фильтрация по сервисам

**Ожидаемый результат:**
```
✅ Загружено 57 capabilities
   READ: 23, WRITE: 34
✅ Все базовые проверки пройдены!
```

### 2. Полный набор тестов

```bash
python3 test_unified_architecture.py
```

**Что проверяет:**
- MCPToolProvider загрузка и классификация
- CapabilityRegistry регистрация и фильтрация
- Фильтрация capabilities по режимам
- Маппинг legacy режимов на новые

**Ожидаемый результат:**
```
✅ Пройдено: 4/4
```

### 3. Интеграционные тесты

```bash
python3 test_integration_modes.py
```

**Что проверяет:**
- Маппинг legacy режимов (instant, react, approval)
- Классификация простых задач
- Полный путь через AgentWrapper

**Ожидаемый результат:**
```
✅ Пройдено: 2/2
```

## Тестирование через UI

### Запуск сервера

```bash
./restart-server.sh
# или
python3 -m uvicorn src.api.server:app --reload
```

### Запуск frontend

```bash
cd frontend
npm run dev
```

### Тестирование режимов

#### Query Mode (Вопрос)
1. Выберите режим "Вопрос" в селекторе
2. Отправьте запрос: "Покажи все встречи на эту неделю"
3. **Ожидаемое поведение:**
   - Используются только READ capabilities
   - Нет попыток создать/изменить что-либо
   - Возвращается только информация

#### Agent Mode (Агент)
1. Выберите режим "Агент" в селекторе
2. Отправьте запрос: "Создай таблицу 'Тест' с заголовками"
3. **Ожидаемое поведение:**
   - Используются все capabilities (READ + WRITE)
   - Адаптивное выполнение
   - Задача выполняется полностью

#### Plan Mode (План)
1. Выберите режим "План" в селекторе
2. Отправьте запрос: "Создай интеграцию с новой системой"
3. **Ожидаемое поведение:**
   - Фаза Research (только чтение)
   - Генерация markdown плана
   - Возможность редактирования плана
   - Выполнение после подтверждения

## Проверка обратной совместимости

### Legacy режимы должны работать:

- `instant` → маппится на `agent` mode
- `react` → маппится на `agent` mode  
- `approval` → маппится на `plan` mode

Проверка:
```bash
python3 test_integration_modes.py
```

## Что проверить в каждом режиме

### Query Mode ✅
- [ ] Используются только READ capabilities
- [ ] Нет попыток выполнить WRITE операции
- [ ] Результат содержит только данные
- [ ] Нет изменений в системе

### Agent Mode ✅
- [ ] Используются все capabilities
- [ ] Адаптивное выполнение при ошибках
- [ ] Задача выполняется полностью
- [ ] Graceful failure с отчетом при невозможности выполнения

### Plan Mode ✅
- [ ] Фаза Research использует только READ
- [ ] Генерируется markdown план
- [ ] План можно редактировать
- [ ] Execution использует все capabilities
- [ ] Адаптивное выполнение плана

## Известные проблемы

1. **WebSocket warnings в тестах** - это нормально, тесты работают без frontend
2. **MCP connection cleanup errors** - не критично, связано с закрытием соединений
3. **Plan Mode timeout** - в тестах без UI план не подтверждается, поэтому timeout ожидаем

## Расширенное тестирование

### Тест с реальными данными

Для полного тестирования с реальными Google API:

1. Убедитесь, что настроены токены в `config/`
2. Запустите MCP серверы:
   ```bash
   ./scripts/start-workspace-mcp.sh
   ./scripts/start-calendar-mcp.sh
   ```
3. Запустите тесты с реальными запросами:
   - Раскомментируйте тесты в `test_unified_architecture.py`
   - Раскомментируйте тесты в `test_integration_modes.py`

### Тест производительности

Для проверки производительности:

```python
import time
start = time.time()
# выполнение теста
end = time.time()
print(f"Время выполнения: {end - start:.2f}s")
```

## Отладка

### Включить debug логирование

В `src/utils/logging_config.py` установите:
```python
log_level = "DEBUG"
```

### Проверить загруженные capabilities

```python
from src.core.providers.mcp_provider import MCPToolProvider
provider = MCPToolProvider()
caps = provider.get_capabilities()
for cap in caps:
    print(f"{cap.name}: {cap.category.value} ({cap.service})")
```

### Проверить маппинг режимов

```python
from src.api.agent_wrapper import AgentWrapper
wrapper = AgentWrapper()
# Проверьте логи при создании сессии с разными режимами
```

## Следующие шаги

После успешного тестирования:

1. ✅ Проверьте все три режима через UI
2. ✅ Протестируйте реальные сценарии использования
3. ✅ Проверьте производительность на сложных задачах
4. ✅ Убедитесь, что старые режимы работают корректно

## Поддержка

При возникновении проблем:
1. Проверьте логи в `logs/`
2. Убедитесь, что все зависимости установлены
3. Проверьте конфигурацию в `config/`
4. Запустите быстрый тест для диагностики

