# Проблема с кэшированием в продакшене

## Симптомы

В продакшене (на удаленном хостинге) отображаются:
1. **Красные панели ошибок** с метаданными в формате JSON (как на скриншоте)
2. **Зеленые части диалога** (thinking chunks)

Эти элементы **НЕ отображаются** в локальной версии.

## Причина

Эти элементы отображаются только когда включен **debug mode**. 

### Возможные причины проблемы:

1. **Кэширование статических файлов в браузере**
   - Браузер закешировал старую версию HTML/CSS/JS файлов
   - Старая версия может иметь включенный debug mode по умолчанию или другую логику отображения
   - Отсутствовали правильные заголовки `Cache-Control` для статических файлов

2. **localStorage сохранил debugMode=true**
   - Пользователь ранее включил debug mode
   - Zustand persist сохранил настройку в `localStorage` (ключ `settings-storage`)
   - Настройка сохраняется между сессиями и перезагрузками

3. **Старая версия фронтенда в продакшене**
   - В продакшене могут быть задеплоены старые файлы
   - Нужно проверить, что новая сборка была задеплоена

## Решение

### 1. Добавлены правильные заголовки кэширования

В `src/api/server.py` добавлены правильные заголовки `Cache-Control`:

- **HTML файлы** (`index.html`, etc.): `no-cache, no-store, must-revalidate`
  - HTML всегда загружается свежий, чтобы получить актуальные ссылки на JS/CSS

- **Assets с хэшами** (например, `index-abc123.js`): `public, max-age=31536000, immutable`
  - Файлы с хэшами в имени immutable — можно кэшировать на 1 год

- **Остальные статические файлы** (SVG, etc.): `public, max-age=3600`
  - Кэшируются на 1 час

### 2. Как проверить, что проблема решена

После деплоя с исправлениями:

1. **Очистите кэш браузера** (Ctrl+Shift+Delete или Cmd+Shift+Delete)
   - Или откройте DevTools → Network → включите "Disable cache"
   - Перезагрузите страницу с Ctrl+Shift+R (Cmd+Shift+R на Mac)

2. **Проверьте localStorage**
   - Откройте DevTools → Application → Local Storage
   - Найдите ключ `settings-storage`
   - Если `debugMode: true`, удалите этот ключ или установите `debugMode: false`

3. **Проверьте версию фронтенда**
   - Откройте DevTools → Network → перезагрузите страницу
   - Проверьте, что загружаются файлы с актуальными хэшами
   - Проверьте заголовки ответа — должны быть правильные `Cache-Control`

### 3. Как принудительно обновить кэш

Если проблема сохраняется после деплоя:

1. **На стороне клиента:**
   - Откройте DevTools → Application → Clear storage → Clear site data
   - Или очистите только Local Storage (удалите `settings-storage`)

2. **На стороне сервера:**
   - Убедитесь, что новая сборка фронтенда была задеплоена
   - Проверьте, что файлы в `frontend/dist/` актуальные
   - Перезапустите сервер, если нужно

### 4. Проверка debug mode

Чтобы проверить, включен ли debug mode:

1. Откройте DevTools → Console
2. Введите: `JSON.parse(localStorage.getItem('settings-storage'))`
3. Проверьте значение `debugMode`

Чтобы отключить debug mode:
- Откройте меню настроек в приложении
- Найдите переключатель "Debug Mode" и выключите его
- Или вручную: `localStorage.setItem('settings-storage', JSON.stringify({state: {debugMode: false}}))`

## Технические детали

### Где отображаются эти элементы:

- **Красные панели ошибок**: `frontend/src/components/ChatMessage.tsx:73-121`
  - Рендерятся только при `debugMode === true` и наличии `debugChunks` типа `error`

- **Зеленые блоки (thinking)**: `frontend/src/components/ChatMessage.tsx:20-21`
  - Цвет `#22c55e` (green) используется для `debugChunks` типа `thinking`

### Настройки по умолчанию:

- `debugMode: false` в `frontend/src/store/settingsStore.ts:69`
- Настройки сохраняются в `localStorage` через Zustand persist
- При обновлении версии приложения localStorage очищается (см. `frontend/src/App.tsx:89-110`)

## Дополнительные замечания

- Если видите эти элементы после очистки кэша, проверьте настройки debug mode в меню
- Если проблема только в продакшене, проверьте, что новая версия была задеплоена
- Если проблема в локальной версии тоже, проверьте настройки в браузере
