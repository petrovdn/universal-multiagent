# Проблема с кэшированием в продакшене (РЕШЕНА)

## Симптомы

В продакшене (на удаленном хостинге) отображались:
1. **Красные панели ошибок** с метаданными в формате JSON (как на скриншоте)
2. **Зеленые части диалога** (thinking chunks)

Эти элементы **НЕ отображались** в локальной версии.

## Причина (УСТАРЕВШИЙ ФУНКЦИОНАЛ)

Эти элементы отображались только в **устаревшем debug mode**, который использовался только в старых версиях приложения и был полностью удалён.

### Проблемы, которые вызывали это:

1. **Кэширование статических файлов в браузере**
   - Браузер закешировал старую версию HTML/CSS/JS файлов с устаревшим debug mode
   - Отсутствовали правильные заголовки `Cache-Control` для статических файлов

2. **localStorage сохранил debugMode=true**
   - Пользователь ранее включил debug mode в старой версии
   - Zustand persist сохранил настройку в `localStorage` (ключ `settings-storage`)
   - Настройка сохранялась между сессиями и перезагрузками

3. **Старая версия фронтенда в продакшене**
   - В продакшене были задеплоены старые файлы с устаревшим функционалом

## Решение

### 1. Удалён устаревший debug mode

Debug mode был полностью удалён из кодовой базы, так как он использовался только в старых версиях и был заменён на reasoning/answer блоки:
- ✅ Удалён переключатель debug mode из SettingsMenu
- ✅ Удалена логика отображения debug chunks из ChatMessage.tsx
- ✅ Удалено создание debug chunks из websocket.ts
- ✅ Удалён debugMode из settingsStore
- ✅ Удалены debug chunks типы и интерфейсы из chatStore
- ✅ Удалены CSS стили для debug mode

### 2. Добавлены правильные заголовки кэширования

В `src/api/server.py` добавлены правильные заголовки `Cache-Control`:

- **HTML файлы** (`index.html`, etc.): `no-cache, no-store, must-revalidate`
  - HTML всегда загружается свежий, чтобы получить актуальные ссылки на JS/CSS

- **Assets с хэшами** (например, `index-abc123.js`): `public, max-age=31536000, immutable`
  - Файлы с хэшами в имени immutable — можно кэшировать на 1 год

- **Остальные статические файлы** (SVG, etc.): `public, max-age=3600`
  - Кэшируются на 1 час

### 3. Как проверить, что проблема решена

После деплоя с исправлениями:

1. **Очистите кэш браузера** (Ctrl+Shift+Delete или Cmd+Shift+Delete)
   - Или откройте DevTools → Network → включите "Disable cache"
   - Перезагрузите страницу с Ctrl+Shift+R (Cmd+Shift+R на Mac)

2. **Проверьте localStorage**
   - Откройте DevTools → Application → Local Storage
   - Найдите ключ `settings-storage`
   - Если есть устаревшее поле `debugMode: true`, оно будет автоматически игнорировано (так как функционал удалён)
   - Можно очистить весь `settings-storage` для полного сброса настроек

3. **Проверьте версию фронтенда**
   - Откройте DevTools → Network → перезагрузите страницу
   - Проверьте, что загружаются файлы с актуальными хэшами
   - Проверьте заголовки ответа — должны быть правильные `Cache-Control`

### 4. Как принудительно обновить кэш

Если проблема сохраняется после деплоя:

1. **На стороне клиента:**
   - Откройте DevTools → Application → Clear storage → Clear site data
   - Или очистите только Local Storage (удалите `settings-storage`)

2. **На стороне сервера:**
   - Убедитесь, что новая сборка фронтенда была задеплоена
   - Проверьте, что файлы в `frontend/dist/` актуальные
   - Перезапустите сервер, если нужно

## Технические детали

### Где отображались эти элементы (УДАЛЕНО):

- **Красные панели ошибок**: `frontend/src/components/ChatMessage.tsx` (удалено)
  - Рендерились только при `debugMode === true` и наличии `debugChunks` типа `error`

- **Зеленые блоки (thinking)**: `frontend/src/components/ChatMessage.tsx` (удалено)
  - Цвет `#22c55e` (green) использовался для `debugChunks` типа `thinking`

### Текущая архитектура:

- Используются **reasoning/answer блоки** вместо debug chunks
- Reasoning блоки показывают процесс рассуждения агента
- Answer блоки показывают финальный ответ
- Настройки сохраняются в `localStorage` через Zustand persist
- При обновлении версии приложения localStorage очищается (см. `frontend/src/App.tsx:89-110`)

## Дополнительные замечания

- **Debug mode полностью удалён** — больше не существует в кодовой базе
- Если проблема сохраняется после деплоя, очистите кэш браузера и localStorage
- Убедитесь, что новая версия была задеплоена в продакшн
- Если видите красные/зеленые панели, значит используется старая версия из кэша
